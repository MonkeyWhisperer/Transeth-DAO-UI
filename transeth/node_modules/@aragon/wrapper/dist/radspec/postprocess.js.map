{"version":3,"file":"postprocess.js","names":["postprocessRadspecDescription","description","wrapper","addressRegex","bytes32RegexStr","bytes32Regex","RegExp","combinedRegex","tokens","split","map","token","trim","filter","length","apps","pipe","first","toPromise","roles","reduce","acc","concat","annotateAddress","input","addressesEqual","ANY_ENTITY","type","value","app","find","proxyAddress","replacement","name","identifier","annotateBytes32","role","bytes","appId","appName","namespace","getKernelNamespace","annotateText","annotatedTokens","test","compiled","_","annotation","push","annotatedDescription","join"],"sources":["../../src/radspec/postprocess.js"],"sourcesContent":["import { first } from 'rxjs/operators'\nimport { getKernelNamespace } from '../core/aragonOS/kernel'\nimport { addressesEqual, ANY_ENTITY } from '../utils'\n\n/**\n  * Look for known addresses and roles in a radspec description and substitute them with a human string\n  *\n  * @param  {string} description\n  * @return {Promise<Object>} Description and annotated description\n  */\nexport async function postprocessRadspecDescription (description, wrapper) {\n  const addressRegexStr = '0x[a-fA-F0-9]{40}'\n  const addressRegex = new RegExp(`^${addressRegexStr}$`)\n  const bytes32RegexStr = '0x[a-f0-9]{64}'\n  const bytes32Regex = new RegExp(`^${bytes32RegexStr}$`)\n  const combinedRegex = new RegExp(`\\\\b(${addressRegexStr}|${bytes32RegexStr})\\\\b`)\n\n  const tokens = description\n    .split(combinedRegex)\n    .map(token => token.trim())\n    .filter(token => token)\n\n  if (tokens.length < 1) {\n    return { description }\n  }\n\n  const apps = await wrapper.apps.pipe(first()).toPromise()\n  const roles = apps\n    .map(({ roles }) => roles || [])\n    .reduce((acc, roles) => acc.concat(roles), []) // flatten\n\n  const annotateAddress = (input) => {\n    if (addressesEqual(input, ANY_ENTITY)) {\n      return [input, '“Any account”', { type: 'any-account', value: ANY_ENTITY }]\n    }\n\n    const app = apps.find(\n      ({ proxyAddress }) => addressesEqual(proxyAddress, input)\n    )\n    if (app) {\n      const replacement = `${app.name}${app.identifier ? ` (${app.identifier})` : ''}`\n      return [input, `“${replacement}”`, { type: 'app', value: app }]\n    }\n\n    return [input, input, { type: 'address', value: input }]\n  }\n\n  const annotateBytes32 = (input) => {\n    const role = roles.find(({ bytes }) => bytes === input)\n\n    if (role && role.name) {\n      return [input, `“${role.name}”`, { type: 'role', value: role }]\n    }\n\n    const app = apps.find(({ appId }) => appId === input)\n\n    if (app) {\n      // return the entire app as it contains APM package details\n      return [input, `“${app.appName}”`, { type: 'apmPackage', value: app }]\n    }\n\n    const namespace = getKernelNamespace(input)\n    if (namespace) {\n      return [input, `“${namespace.name}”`, { type: 'kernelNamespace', value: namespace }]\n    }\n\n    return [input, input, { type: 'bytes32', value: input }]\n  }\n\n  const annotateText = (input) => {\n    return [input, input, { type: 'text', value: input }]\n  }\n\n  const annotatedTokens = tokens.map(token => {\n    if (addressRegex.test(token)) {\n      return annotateAddress(token)\n    }\n    if (bytes32Regex.test(token)) {\n      return annotateBytes32(token)\n    }\n    return annotateText(token)\n  })\n\n  const compiled = annotatedTokens.reduce((acc, [_, replacement, annotation]) => {\n    acc.description.push(replacement)\n    acc.annotatedDescription.push(annotation)\n    return acc\n  }, {\n    annotatedDescription: [],\n    description: []\n  })\n\n  return {\n    annotatedDescription: compiled.annotatedDescription,\n    description: compiled.description.join(' ')\n  }\n}\n"],"mappings":"iEAqeuB;sLAjevB;AACA;AACA;AACA;AACA;AACA,IACO,cAAeA,8BAAf,CAA8CC,WAA9C,CAA2DC,OAA3D,CAAoE,MAEnEC,aAAY,sBAFuD,CAGnEC,eAAe,CAAG,gBAHiD,CAInEC,YAAY,CAAG,GAAIC,OAAJ,CAAY,IAAGF,eAAgB,GAA/B,CAJoD,CAKnEG,aAAa,CAAG,GAAID,OAAJ,CAAY,OAAD,mBAAuB,IAAGF,eAAgB,MAArD,CALmD,CAOnEI,MAAM,CAAGP,WAAW,CACvBQ,KADY,CACNF,aADM,EAEZG,GAFY,CAERC,KAAK,EAAIA,KAAK,CAACC,IAAN,EAFD,EAGZC,MAHY,CAGLF,KAAK,EAAIA,KAHJ,CAP0D,CAYzE,GAAoB,CAAhB,CAAAH,MAAM,CAACM,MAAX,CACE,MAAO,CAAEb,WAAF,CAAP,CAbuE,KAgBnEc,KAAI,CAAG,KAAMb,QAAO,CAACa,IAAR,CAAaC,IAAb,CAAkB,GAAAC,gBAAA,GAAlB,EAA2BC,SAA3B,EAhBsD,CAiBnEC,KAAK,CAAGJ,IAAI,CACfL,GADW,CACP,UAAC,CAAES,KAAF,CAAD,YAAeA,MAAK,EAAI,EAAxB,CADO,EAEXC,MAFW,CAEJ,CAACC,GAAD,CAAMF,KAAN,GAAgBE,GAAG,CAACC,MAAJ,CAAWH,KAAX,CAFZ,CAE+B,EAF/B,CAjB2D,CAqBnEI,eAAe,CAAIC,KAAD,EAAW,CACjC,GAAI,GAAAC,qBAAA,EAAeD,KAAf,CAAsBE,iBAAtB,CAAJ,CACE,MAAO,CAACF,KAAD,CAAQ,yBAAR,CAAyB,CAAEG,IAAI,CAAE,aAAR,CAAuBC,KAAK,CAAEF,iBAA9B,CAAzB,CAAP,CAGF,KAAMG,IAAG,CAAGd,IAAI,CAACe,IAAL,CACV,WAAC,CAAEC,YAAF,CAAD,aAAsB,GAAAN,qBAAA,EAAeM,YAAf,CAA6BP,KAA7B,CAAtB,CADU,CAAZ,CAGA,GAAIK,GAAJ,CAAS,CACP,KAAMG,YAAW,CAAI,GAAEH,GAAG,CAACI,IAAK,GAAEJ,GAAG,CAACK,UAAJ,CAAkB,KAAIL,GAAG,CAACK,UAAW,GAArC,CAA0C,EAAG,EAA/E,CACA,MAAO,CAACV,KAAD,CAAS,IAAGQ,WAAY,GAAxB,CAA4B,CAAEL,IAAI,CAAE,KAAR,CAAeC,KAAK,CAAEC,GAAtB,CAA5B,CACR,CAED,MAAO,CAACL,KAAD,CAAQA,KAAR,CAAe,CAAEG,IAAI,CAAE,SAAR,CAAmBC,KAAK,CAAEJ,KAA1B,CAAf,CACR,CAnCwE,CAqCnEW,eAAe,CAAIX,KAAD,EAAW,CACjC,KAAMY,KAAI,CAAGjB,KAAK,CAACW,IAAN,CAAW,WAAC,CAAEO,KAAF,CAAD,aAAeA,MAAK,GAAKb,KAAzB,CAAX,CAAb,CAEA,GAAIY,IAAI,EAAIA,IAAI,CAACH,IAAjB,CACE,MAAO,CAACT,KAAD,CAAS,IAAGY,IAAI,CAACH,IAAK,GAAtB,CAA0B,CAAEN,IAAI,CAAE,MAAR,CAAgBC,KAAK,CAAEQ,IAAvB,CAA1B,CAAP,CAGF,KAAMP,IAAG,CAAGd,IAAI,CAACe,IAAL,CAAU,WAAC,CAAEQ,KAAF,CAAD,aAAeA,MAAK,GAAKd,KAAzB,CAAV,CAAZ,CAEA,GAAIK,GAAJ,CACE;AACA,MAAO,CAACL,KAAD,CAAS,IAAGK,GAAG,CAACU,OAAQ,GAAxB,CAA4B,CAAEZ,IAAI,CAAE,YAAR,CAAsBC,KAAK,CAAEC,GAA7B,CAA5B,CAAP,CAGF,KAAMW,UAAS,CAAG,GAAAC,0BAAA,EAAmBjB,KAAnB,CAAlB,CAdiC,MAe7BgB,UAf6B,CAgBxB,CAAChB,KAAD,CAAS,IAAGgB,SAAS,CAACP,IAAK,GAA3B,CAA+B,CAAEN,IAAI,CAAE,iBAAR,CAA2BC,KAAK,CAAEY,SAAlC,CAA/B,CAhBwB,CAmB1B,CAAChB,KAAD,CAAQA,KAAR,CAAe,CAAEG,IAAI,CAAE,SAAR,CAAmBC,KAAK,CAAEJ,KAA1B,CAAf,CACR,CAzDwE,CA2DnEkB,YAAY,CAAIlB,KAAD,EACZ,CAACA,KAAD,CAAQA,KAAR,CAAe,CAAEG,IAAI,CAAE,MAAR,CAAgBC,KAAK,CAAEJ,KAAvB,CAAf,CA5DgE,CA+DnEmB,eAAe,CAAGnC,MAAM,CAACE,GAAP,CAAWC,KAAK,EAClCR,YAAY,CAACyC,IAAb,CAAkBjC,KAAlB,CADkC,CAE7BY,eAAe,CAACZ,KAAD,CAFc,CAIlCN,YAAY,CAACuC,IAAb,CAAkBjC,KAAlB,CAJkC,CAK7BwB,eAAe,CAACxB,KAAD,CALc,CAO/B+B,YAAY,CAAC/B,KAAD,CAPG,CA/DiD,CAyEnEkC,QAAQ,CAAGF,eAAe,CAACvB,MAAhB,CAAuB,CAACC,GAAD,SAAuC,IAAjC,CAACyB,CAAD,CAAId,WAAJ,CAAiBe,UAAjB,CAAiC,OAG7E,MAFA1B,IAAG,CAACpB,WAAJ,CAAgB+C,IAAhB,CAAqBhB,WAArB,CAEA,CADAX,GAAG,CAAC4B,oBAAJ,CAAyBD,IAAzB,CAA8BD,UAA9B,CACA,CAAO1B,GACR,CAJgB,CAId,CACD4B,oBAAoB,CAAE,EADrB,CAEDhD,WAAW,CAAE,EAFZ,CAJc,CAzEwD,CAkFzE,MAAO,CACLgD,oBAAoB,CAAEJ,QAAQ,CAACI,oBAD1B,CAELhD,WAAW,CAAE4C,QAAQ,CAAC5C,WAAT,CAAqBiD,IAArB,CAA0B,GAA1B,CAFR,CAIR"}