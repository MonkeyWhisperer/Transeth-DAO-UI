{"version":3,"file":"trigger.test.js","names":["test","afterEach","always","sinon","restore","t","plan","triggerContextMock","of","event","returnValues","data","appContextPoolStub","get","stub","withArgs","APP_CONTEXTS","TRIGGER","returns","result","trigger","params","address","appContextPool","emitIndex","subscribe","value","deepEqual","fail","newEventName","newEventData","emit","true","calledOnceWith","throwsAsync","message"],"sources":["../../../src/rpc/handlers/trigger.test.js"],"sourcesContent":["import test from 'ava'\nimport sinon from 'sinon'\nimport { of } from 'rxjs'\n\nimport { APP_CONTEXTS } from '../../apps'\nimport trigger from './trigger'\n\ntest.afterEach.always(() => {\n  sinon.restore()\n})\n\ntest(\"should return an observable for the app's triggers\", async (t) => {\n  t.plan(3)\n\n  // arrange\n  const appAddress = '0xABCD'\n  const triggerContextMock = of(\n    {\n      event: 'event1',\n      returnValues: {\n        data: 'data1'\n      }\n    },\n    {\n      event: 'event2',\n      returnValues: {\n        data: 'data2'\n      }\n    },\n    {\n      event: 'event3',\n      returnValues: {\n        data: 'data3'\n      }\n    }\n  )\n  const requestStub = {\n    params: ['observe']\n  }\n  const proxyStub = {\n    address: appAddress\n  }\n  const appContextPoolStub = {\n    get: sinon\n      .stub()\n      .withArgs(appAddress, APP_CONTEXTS.TRIGGER)\n      .returns(triggerContextMock)\n  }\n  const wrapperStub = {\n    appContextPool: appContextPoolStub\n  }\n\n  // act\n  const result = trigger(requestStub, proxyStub, wrapperStub)\n\n  // assert\n  let emitIndex = 0\n  result.subscribe(value => {\n    if (emitIndex === 0) {\n      t.deepEqual(value, {\n        event: 'event1',\n        returnValues: {\n          data: 'data1'\n        }\n      })\n    } else if (emitIndex === 1) {\n      t.deepEqual(value, {\n        event: 'event2',\n        returnValues: {\n          data: 'data2'\n        }\n      })\n    } else if (emitIndex === 2) {\n      t.deepEqual(value, {\n        event: 'event3',\n        returnValues: {\n          data: 'data3'\n        }\n      })\n    } else {\n      t.fail('too many emissions')\n    }\n\n    emitIndex++\n  })\n})\n\ntest('should emit trigger', async (t) => {\n  t.plan(1)\n\n  // arrange\n  const appAddress = '0xABCD'\n  const newEventName = 'newEvent'\n  const newEventData = 'newData'\n  const requestStub = {\n    params: ['emit', newEventName, newEventData]\n  }\n  const proxyStub = {\n    address: appAddress\n  }\n  const appContextPoolStub = {\n    emit: sinon.stub()\n  }\n  const wrapperStub = {\n    appContextPool: appContextPoolStub\n  }\n\n  // act\n  trigger(requestStub, proxyStub, wrapperStub)\n\n  // assert\n  t.true(appContextPoolStub.emit.calledOnceWith(\n    appAddress,\n    APP_CONTEXTS.TRIGGER,\n    {\n      event: newEventName,\n      returnValues: newEventData\n    }\n  ))\n})\n\ntest('should error on invalid trigger request', async (t) => {\n  t.plan(1)\n\n  // arrange\n  const appAddress = '0xABCD'\n  const requestStub = {\n    params: ['notHandled']\n  }\n  const proxyStub = {\n    address: appAddress\n  }\n\n  // assert\n  await t.throwsAsync(\n    trigger(requestStub, proxyStub),\n    { message: 'Invalid trigger operation' }\n  )\n})\n"],"mappings":"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"}