{"version":3,"file":"external.js","names":["call","request","proxy","wrapper","web3","address","methodAbiFragment","params","contract","eth","Contract","methods","name","intent","transactionPath","getExternalTransactionPath","performTransactionPath","external","events","jsonInterface","eventNames","eventOptions","length","getEventNames","fromBlock","initializationBlock","eventSource","fromEvent","allEvents","pipe","filter","event","includes","eventDelay","getConfiguration","configurationKeys","SUBSCRIPTION_EVENT_DELAY","delay","pastEvents","PAST_EVENTS_BLOCK_SIZE","blockSizeLimit","from","getPastEventsByBatch","options","eventName","getPastEvents","then"],"sources":["../../../src/rpc/handlers/external.js"],"sourcesContent":["import { fromEvent, from } from 'rxjs'\nimport { delay, filter } from 'rxjs/operators'\nimport { getConfiguration } from '../../configuration'\nimport * as configurationKeys from '../../configuration/keys'\nimport { getEventNames, getPastEventsByBatch } from '../../utils/events'\n\nexport function call (request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    methodAbiFragment,\n    ...params\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    [methodAbiFragment],\n    address\n  )\n\n  return contract.methods[methodAbiFragment.name](...params).call()\n}\n\nexport async function intent (request, proxy, wrapper) {\n  const [\n    address,\n    methodAbiFragment,\n    ...params\n  ] = request.params\n\n  const transactionPath = await wrapper.getExternalTransactionPath(\n    address,\n    methodAbiFragment,\n    params\n  )\n\n  return wrapper.performTransactionPath(transactionPath, { external: true })\n}\n\nexport function events (request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    jsonInterface\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    jsonInterface,\n    address\n  )\n\n  // `external_events` RPC compatibility with aragonAPI versions:\n  //   - aragonAPIv2: `'external_events', [address, jsonInterface, eventNames, eventOptions]`\n  //   - aragonAPIv1: `'external_events', [address, jsonInterface, fromBlock (optional)]`\n  let eventNames\n  let eventOptions\n  if (request.params.length === 4) {\n    // aragonAPIv2\n    eventNames = getEventNames(request.params[2])\n    eventOptions = request.params[3]\n  } else if (request.params.length <= 3) {\n    // aragonAPIv1\n    eventNames = ['allEvents']\n    eventOptions = { fromBlock: request.params[2] }\n  }\n  // Use the app proxy's initialization block by default\n  if (eventOptions.fromBlock == null) {\n    eventOptions.fromBlock = proxy.initializationBlock\n  }\n\n  let eventSource\n  if (eventNames.length === 1) {\n    // Get a specific event or all events unfiltered\n    eventSource = fromEvent(\n      contract.events[eventNames[0]](eventOptions),\n      'data'\n    )\n  } else {\n    // Get all events and filter ourselves\n    eventSource = fromEvent(\n      this.contract.events.allEvents(eventOptions),\n      'data'\n    ).pipe(\n      filter((event) => eventNames.includes(event.event))\n    )\n  }\n\n  const eventDelay = getConfiguration(configurationKeys.SUBSCRIPTION_EVENT_DELAY) || 0\n  // Small optimization: don't pipe a delay if we don't have to\n  return eventDelay ? eventSource.pipe(delay(eventDelay)) : eventSource\n}\n\nexport function pastEvents (request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    jsonInterface\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    jsonInterface,\n    address\n  )\n\n  // `external_past_events` RPC compatibility with aragonAPI versions:\n  //   - aragonAPIv2: `'external_past_events', [address, jsonInterface, eventNames, eventOptions]`\n  //   - aragonAPIv1: `'external_past_events', [address, jsonInterface, eventOptions]`\n  let eventNames\n  let eventOptions\n  if (request.params.length === 4) {\n    // aragonAPIv2\n    eventNames = getEventNames(request.params[2])\n    eventOptions = request.params[3]\n  } else if (request.params.length === 3) {\n    // aragonAPIv1\n    eventNames = ['allEvents']\n    eventOptions = request.params[2]\n  }\n  // Use the app proxy's initialization block by default\n  if (eventOptions.fromBlock == null) {\n    eventOptions.fromBlock = proxy.initializationBlock\n  }\n\n  // The `from`s only unpack the returned Promises (and not the array inside them!)\n  if (eventNames.length === 1) {\n    // Get a specific event or all events unfiltered\n    if (!getConfiguration(configurationKeys.PAST_EVENTS_BLOCK_SIZE)) {\n      return from(\n        contract.getPastEvents(eventNames[0], eventOptions)\n      )\n    }\n    eventOptions.blockSizeLimit = getConfiguration(configurationKeys.PAST_EVENTS_BLOCK_SIZE)\n\n    return from(\n      getPastEventsByBatch({ options: eventOptions, contract: contract, eventName: eventNames[0] })\n    )\n  } else {\n    // Get all events and filter ourselves\n    return from(\n      contract.getPastEvents('allEvents', eventOptions)\n        .then(events => events.filter(event => eventNames.includes(event.event)))\n    )\n  }\n}\n"],"mappings":"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"}