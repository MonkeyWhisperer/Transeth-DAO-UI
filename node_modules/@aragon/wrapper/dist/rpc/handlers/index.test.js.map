{"version":3,"file":"index.test.js","names":["test","afterEach","always","sinon","restore","t","plan","requestStub","from","request","id","method","params","value","foo","result","createRequestHandler","Promise","resolve","reject","Error","completed","Set","subscribe","next","payload","signals","COMPLETE","has","fail","add","is","message","true","complete","deepEqual","sort","handlerA","of","handlerB","combineRequestHandlers"],"sources":["../../../src/rpc/handlers/index.test.js"],"sourcesContent":["import test from 'ava'\nimport sinon from 'sinon'\nimport { of, from } from 'rxjs'\nimport { signals } from '@aragon/rpc-messenger'\n\nimport {\n  createRequestHandler,\n  combineRequestHandlers\n} from './index'\n\ntest.afterEach.always(() => {\n  sinon.restore()\n})\n\ntest('should create a request handler', async (t) => {\n  t.plan(8)\n  // arrange\n  const requestStub = from([{\n    request: {\n      id: 'uuid0',\n      // this one should get filtered away\n      method: 'accounts'\n    }\n  }, {\n    request: {\n      id: 'uuid1',\n      method: 'cache',\n      params: ['get', 'settings']\n    }\n  }, {\n    request: {\n      id: 'uuid4',\n      method: 'cache',\n      params: ['set', 'settings'],\n      value: { foo: 'bar' }\n    }\n  }, {\n    request: {\n      id: 'uuid5',\n      method: 'cache',\n      params: ['clear']\n    }\n  }, {\n    request: {\n      id: 'uuid6',\n      method: 'cache',\n      params: ['get', 'profile']\n    }\n  }, {\n    request: {\n      // this one should NOT get filtered away, but assigned a default response of null\n      id: 'uuid8',\n      method: 'cache'\n    }\n  }])\n  const handlerStub = (request) => {\n    if (request.id === 'uuid8') {\n      // undefined result, this will get converted into null so it can be transmited over JSON RPC\n      return Promise.resolve()\n    }\n\n    if (request.params[0] === 'set') {\n      return Promise.reject(new Error(`no permissions to change ${request.params[1]}!!`))\n    }\n\n    if (request.params[0] === 'clear') {\n      return Promise.reject(new Error())\n    }\n\n    return Promise.resolve(`resolved ${request.params[1]}`)\n  }\n  // act\n  const result = createRequestHandler(requestStub, 'cache', handlerStub)\n  // assert\n  const completed = new Set()\n  result.subscribe({\n    next (value) {\n      if (value.payload === signals.COMPLETE) {\n        if (completed.has(value.id)) {\n          t.fail(`request (${value.id}) completed twice`)\n        }\n        completed.add(value.id)\n        return\n      }\n\n      if (value.id === 'uuid1') {\n        return t.is(value.payload, 'resolved settings')\n      }\n      if (value.id === 'uuid4') {\n        t.is(value.payload.message, 'no permissions to change settings!!')\n        return t.true(value.payload instanceof Error)\n      }\n      if (value.id === 'uuid5') {\n        t.is(value.payload.message, '')\n        return t.true(value.payload instanceof Error)\n      }\n      if (value.id === 'uuid6') {\n        return t.is(value.payload, 'resolved profile')\n      }\n      if (value.id === 'uuid8') {\n        return t.is(value.payload, null)\n      }\n    },\n    // Check non-erroring requests completed correctly\n    complete () {\n      return t.deepEqual([...completed].sort(), ['uuid1', 'uuid6', 'uuid8'])\n    }\n  })\n})\n\ntest('should combine request handlers', async (t) => {\n  t.plan(2)\n  // arrange\n  const handlerA = of('handler for A')\n  const handlerB = of('handler for B')\n  // act\n  const result = combineRequestHandlers(handlerA, handlerB)\n  // assert\n  result.subscribe(value => {\n    t.true(value === 'handler for A' || value === 'handler for B')\n  })\n})\n"],"mappings":"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"}