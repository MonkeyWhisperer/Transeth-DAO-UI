{"version":3,"file":"get-apps.js","names":["transformAppInformation","app","getContentPathFn","abi","appId","content","contractAddress","icons","identifier","isForwarder","kernelAddress","name","proxyAddress","roles","iconsWithBaseUrl","map","icon","src","_","appAddress","appImplementationAddress","request","proxy","wrapper","operation","params","appCategory","apps","appWithIdentifier$","combineLatest","appIdentifiers","pipe","identifiers","apm","getContentPath","app$","find","addressesEqual","address","first","Promise","reject","Error"],"sources":["../../../src/rpc/handlers/get-apps.js"],"sourcesContent":["import { combineLatest } from 'rxjs'\nimport { first, map } from 'rxjs/operators'\nimport { addressesEqual } from '../../utils'\n\n// Extract just a few important details about the current app to decrease API surface area\nfunction transformAppInformation (app = {}, getContentPathFn) {\n  const {\n    abi,\n    appId,\n    content,\n    contractAddress,\n    icons,\n    identifier,\n    isForwarder,\n    kernelAddress,\n    name,\n    proxyAddress,\n    roles\n  } = app\n\n  let iconsWithBaseUrl\n  try {\n    iconsWithBaseUrl = icons.map((icon) =>\n      ({ ...icon, src: getContentPathFn(content, icon.src) })\n    )\n  } catch (_) {}\n\n  return {\n    abi,\n    identifier,\n    kernelAddress,\n    name,\n    appAddress: proxyAddress,\n    appId: appId,\n    appImplementationAddress: contractAddress,\n    icons: iconsWithBaseUrl,\n    isForwarder: Boolean(isForwarder),\n    roles\n  }\n}\n\nexport default function (request, proxy, wrapper) {\n  const operation = request.params[0]\n  let appCategory = request.params[1]\n  if (appCategory !== 'all' && appCategory !== 'current') {\n    appCategory = 'all'\n  }\n\n  // Backwards compatibility with initial RPC API (no parameters passed)\n  if (operation === undefined) {\n    return wrapper.apps\n  }\n\n  const appWithIdentifier$ = combineLatest(wrapper.apps, wrapper.appIdentifiers).pipe(\n    map(([apps, identifiers]) =>\n      apps.map((app) =>\n        ({\n          ...app,\n          identifier: identifiers[app.proxyAddress]\n        })\n      )\n    )\n  )\n\n  const getContentPathFn = wrapper.apm.getContentPath\n  const app$ = appCategory === 'current'\n    ? appWithIdentifier$.pipe(\n      map(apps => apps.find(app => addressesEqual(app.proxyAddress, proxy.address))),\n      map((app) => transformAppInformation(app, getContentPathFn))\n    )\n    : appWithIdentifier$.pipe(\n      map((apps) => apps.map((app) => transformAppInformation(app, getContentPathFn)))\n    )\n  if (operation === 'observe') {\n    return app$\n  }\n  if (operation === 'get') {\n    return app$.pipe(first())\n  }\n\n  return Promise.reject(\n    new Error('Invalid get apps operation')\n  )\n}\n"],"mappings":"oJAqeuB;g+BAjevB;AACA,QAASA,wBAAT,EAA8D,IAA5BC,IAA4B,wDAAtB,EAAsB,CAAlBC,gBAAkB,wCAC5D,KAAM,CACJC,GADI,CAEJC,KAFI,CAGJC,OAHI,CAIJC,eAJI,CAKJC,KALI,CAMJC,UANI,CAOJC,WAPI,CAQJC,aARI,CASJC,IATI,CAUJC,YAVI,CAWJC,KAXI,EAYFZ,GAZJ,CAcA,GAAIa,iBAAJ,CACA,GAAI,CACFA,gBAAgB,CAAGP,KAAK,CAACQ,GAAN,CAAWC,IAAD,iCACrBA,IADqB,MACfC,GAAG,CAAEf,gBAAgB,CAACG,OAAD,CAAUW,IAAI,CAACC,GAAf,CADN,EAAV,CAGpB,CAAC,MAAOC,CAAP,CAAU,CAAE,CAEd,MAAO,CACLf,GADK,CAELK,UAFK,CAGLE,aAHK,CAILC,IAJK,CAKLQ,UAAU,CAAEP,YALP,CAMLR,KAAK,CAAEA,KANF,CAOLgB,wBAAwB,CAAEd,eAPrB,CAQLC,KAAK,CAAEO,gBARF,CASLL,WAAW,GAAUA,WAThB,CAULI,KAVK,CAYR,CAEc,kBAAUQ,OAAV,CAAmBC,KAAnB,CAA0BC,OAA1B,CAAmC,CAChD,KAAMC,UAAS,CAAGH,OAAO,CAACI,MAAR,CAAe,CAAf,CAAlB,CACA,GAAIC,YAAW,CAAGL,OAAO,CAACI,MAAR,CAAe,CAAf,CAAlB,CAKA;AACA,GALoB,KAAhB,GAAAC,WAAW,EAA8B,SAAhB,GAAAA,WAK7B,GAJEA,WAAW,CAAG,KAIhB,EAAI,SAAAF,SAAJ,CACE,MAAOD,QAAO,CAACI,IAAf,CAT8C,KAY1CC,mBAAkB,CAAG,GAAAC,mBAAA,EAAcN,OAAO,CAACI,IAAtB,CAA4BJ,OAAO,CAACO,cAApC,EAAoDC,IAApD,CACzB,GAAAhB,cAAA,EAAI,UAAC,CAACY,IAAD,CAAOK,WAAP,CAAD,YACFL,KAAI,CAACZ,GAAL,CAAUd,GAAD,iCAEFA,GAFE,MAGLO,UAAU,CAAEwB,WAAW,CAAC/B,GAAG,CAACW,YAAL,CAHlB,EAAT,CADE,CAAJ,CADyB,CAZqB,CAuB1CV,gBAAgB,CAAGqB,OAAO,CAACU,GAAR,CAAYC,cAvBW,CAwB1CC,IAAI,CAAmB,SAAhB,GAAAT,WAAW,CACpBE,kBAAkB,CAACG,IAAnB,CACA,GAAAhB,cAAA,EAAIY,IAAI,EAAIA,IAAI,CAACS,IAAL,CAAUnC,GAAG,EAAI,GAAAoC,qBAAA,EAAepC,GAAG,CAACW,YAAnB,CAAiCU,KAAK,CAACgB,OAAvC,CAAjB,CAAZ,CADA,CAEA,GAAAvB,cAAA,EAAKd,GAAD,EAASD,uBAAuB,CAACC,GAAD,CAAMC,gBAAN,CAApC,CAFA,CADoB,CAKpB0B,kBAAkB,CAACG,IAAnB,CACA,GAAAhB,cAAA,EAAKY,IAAD,EAAUA,IAAI,CAACZ,GAAL,CAAUd,GAAD,EAASD,uBAAuB,CAACC,GAAD,CAAMC,gBAAN,CAAzC,CAAd,CADA,CA7B4C,OAgC9B,SAAd,GAAAsB,SAhC4C,CAiCvCW,IAjCuC,CAmC9B,KAAd,GAAAX,SAnC4C,CAoCvCW,IAAI,CAACJ,IAAL,CAAU,GAAAQ,gBAAA,GAAV,CApCuC,CAuCzCC,OAAO,CAACC,MAAR,CACL,GAAIC,MAAJ,CAAU,4BAAV,CADK,CAGR"}