{"version":3,"file":"transactions.js","names":["DEFAULT_GAS_FUZZ_FACTOR","PREVIOUS_BLOCK_GAS_LIMIT_FACTOR","applyPretransaction","directTransaction","web3","token","from","to","address","tokenAddress","value","tokenValue","spender","approveSpender","erc20ABI","getAbi","tokenContract","eth","Contract","balance","methods","balanceOf","call","tokenValueBN","toBN","lt","Error","allowance","allowanceBN","gt","console","warn","tokenApproveTransaction","data","approve","encodeABI","pretransaction","applyForwardingFeePretransaction","forwardingTransaction","forwarder","forwardFee","feeDetails","amount","feeResult","err","toString","createDirectTransaction","sender","destination","methodAbiFragment","params","paramsIncludesTransactionOptions","type","length","inputs","transactionOptions","options","pop","abi","encodeFunctionCall","createDirectTransactionForApp","app","methodSignature","proxyAddress","findMethodAbiFragment","createForwarderTransactionBuilder","forwardMethod","forwarderAddress","script","getRecommendedGasLimit","estimatedGasLimit","gasFuzzFactor","latestBlock","getBlock","latestBlockGasLimit","gasLimit","upperGasLimit","Math","round","bufferedGasLimit"],"sources":["../../src/utils/transactions.js"],"sourcesContent":["import { toBN } from 'web3-utils'\nimport { getAbi } from '../interfaces'\nimport { findMethodAbiFragment } from './abi'\n\nconst DEFAULT_GAS_FUZZ_FACTOR = 1.5\nconst PREVIOUS_BLOCK_GAS_LIMIT_FACTOR = 0.95\n\nexport async function applyPretransaction (directTransaction, web3) {\n  // Token allowance pretransaction\n  if (directTransaction.token) {\n    const {\n      from,\n      to,\n      token: { address: tokenAddress, value: tokenValue, spender }\n    } = directTransaction\n\n    // Approve the transaction destination unless an spender is passed to approve a different contract\n    const approveSpender = spender || to\n\n    const erc20ABI = getAbi('standard/ERC20')\n    const tokenContract = new web3.eth.Contract(erc20ABI, tokenAddress)\n    const balance = await tokenContract.methods.balanceOf(from).call()\n\n    const tokenValueBN = toBN(tokenValue)\n\n    if (toBN(balance).lt(tokenValueBN)) {\n      throw new Error(`Balance too low. ${from} balance of ${tokenAddress} token is ${balance} (attempting to send ${tokenValue})`)\n    }\n\n    const allowance = await tokenContract.methods.allowance(from, approveSpender).call()\n    const allowanceBN = toBN(allowance)\n\n    // If allowance is already greater than or equal to amount, there is no need to do an approve transaction\n    if (allowanceBN.lt(tokenValueBN)) {\n      if (allowanceBN.gt(toBN(0))) {\n        // TODO: Actually handle existing approvals (some tokens fail when the current allowance is not 0)\n        console.warn(`${from} already approved ${approveSpender}. In some tokens, approval will fail unless the allowance is reset to 0 before re-approving again.`)\n      }\n\n      const tokenApproveTransaction = {\n        // TODO: should we include transaction options?\n        from,\n        to: tokenAddress,\n        data: tokenContract.methods.approve(approveSpender, tokenValue).encodeABI()\n      }\n\n      directTransaction.pretransaction = tokenApproveTransaction\n      delete directTransaction.token\n    }\n  }\n\n  return directTransaction\n}\n\nexport async function applyForwardingFeePretransaction (forwardingTransaction, web3) {\n  const { to: forwarder, from } = forwardingTransaction\n\n  // Check if a token approval pretransaction is needed due to the forwarder requiring a fee\n  const forwardFee = new web3.eth.Contract(\n    getAbi('aragon/ForwarderFee'),\n    forwarder\n  ).methods['forwardFee']\n\n  const feeDetails = { amount: toBN(0) }\n  try {\n    // Passing the EOA as `msg.sender` to the forwardFee call is useful for use cases where the fee differs relative to the account\n    const feeResult = await forwardFee().call({ from }) // forwardFee() returns (address, uint256)\n    feeDetails.tokenAddress = feeResult[0]\n    feeDetails.amount = toBN(feeResult[1])\n  } catch (err) {\n    // Not all forwarders implement the `forwardFee()` interface\n  }\n\n  if (feeDetails.tokenAddress && feeDetails.amount.gt(toBN(0))) {\n    // Needs a token approval pretransaction\n    forwardingTransaction.token = {\n      address: feeDetails.tokenAddress,\n      spender: forwarder, // since it's a forwarding transaction, always show the real spender\n      value: feeDetails.amount.toString()\n    }\n  }\n\n  return applyPretransaction(forwardingTransaction, web3)\n}\n\nexport async function createDirectTransaction (sender, destination, methodAbiFragment, params, web3) {\n  let paramsIncludesTransactionOptions = false\n  if (methodAbiFragment.type === 'fallback') {\n    if (params.length > 1) {\n      throw new Error('Could not create transaction to fallback function due to too many parameters', params)\n    }\n\n    paramsIncludesTransactionOptions = params.length === 1\n  } else if (\n    methodAbiFragment.inputs.length + 1 === params.length &&\n    typeof params[params.length - 1] === 'object'\n  ) {\n    paramsIncludesTransactionOptions = true\n  }\n\n  let transactionOptions = {}\n  if (paramsIncludesTransactionOptions) {\n    const options = params.pop()\n    transactionOptions = { ...transactionOptions, ...options }\n  }\n\n  // The direct transaction we eventually want to perform\n  const directTransaction = {\n    ...transactionOptions, // Options are overwriten by the values below\n    from: sender,\n    to: destination,\n    data: web3.eth.abi.encodeFunctionCall(methodAbiFragment, params)\n  }\n\n  // Add any pretransactions specified\n  return applyPretransaction(directTransaction, web3)\n}\n\nexport async function createDirectTransactionForApp (sender, app, methodSignature, params, web3) {\n  if (!app) {\n    throw new Error('Could not create transaction due to missing app artifact')\n  }\n\n  const { proxyAddress: destination } = app\n\n  if (!app.abi) {\n    throw new Error(`No ABI specified in artifact for ${destination}`)\n  }\n\n  const methodAbiFragment = findMethodAbiFragment(app.abi, methodSignature)\n  if (!methodAbiFragment) {\n    throw new Error(`${methodSignature} not found on ABI for ${destination}`)\n  }\n\n  return createDirectTransaction(sender, destination, methodAbiFragment, params, web3)\n}\n\nexport function createForwarderTransactionBuilder (sender, directTransaction, web3) {\n  const forwardMethod = new web3.eth.Contract(\n    getAbi('aragon/Forwarder')\n  ).methods['forward']\n\n  return (forwarderAddress, script) => (\n    {\n      ...directTransaction, // Options are overwriten by the values below\n      from: sender,\n      to: forwarderAddress,\n      data: forwardMethod(script).encodeABI()\n    }\n  )\n}\n\nexport async function getRecommendedGasLimit (web3, estimatedGasLimit, { gasFuzzFactor = DEFAULT_GAS_FUZZ_FACTOR } = {}) {\n  const latestBlock = await web3.eth.getBlock('latest')\n  const latestBlockGasLimit = latestBlock.gasLimit\n\n  const upperGasLimit = Math.round(latestBlockGasLimit * PREVIOUS_BLOCK_GAS_LIMIT_FACTOR)\n  const bufferedGasLimit = Math.round(estimatedGasLimit * gasFuzzFactor)\n\n  if (estimatedGasLimit > upperGasLimit) {\n    // TODO: Consider whether we should throw an error rather than returning with a high gas limit\n    return estimatedGasLimit\n  } else if (bufferedGasLimit < upperGasLimit) {\n    return bufferedGasLimit\n  } else {\n    return upperGasLimit\n  }\n}\n"],"mappings":"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"}