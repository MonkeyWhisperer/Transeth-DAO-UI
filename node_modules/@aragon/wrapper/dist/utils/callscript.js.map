{"version":3,"file":"callscript.js","names":["CALLSCRIPT_ID","decodeSegment","script","to","substring","dataLength","parseInt","data","segment","scriptLeft","decodeCallScript","isCallScript","Error","scriptData","segments","length","push","encodeCallScript","actions","reduce","address","abi","encodeParameter","toString","slice","scriptId"],"sources":["../../src/utils/callscript.js"],"sourcesContent":["import abi from 'web3-eth-abi'\n\nexport const CALLSCRIPT_ID = '0x00000001'\n\nfunction decodeSegment (script) {\n  // Get address\n  const to = `0x${script.substring(0, 40)}`\n  script = script.substring(40)\n\n  // Get data\n  const dataLength = parseInt(`0x${script.substring(0, 8)}`, 16) * 2\n  script = script.substring(8)\n  const data = `0x${script.substring(0, dataLength)}`\n\n  // Return rest of script for processing\n  script = script.substring(dataLength)\n\n  return {\n    segment: {\n      to,\n      data\n    },\n    scriptLeft: script\n  }\n}\n\n/**\n * Decode a call script bytes string into its actions.\n *\n * Will return an array containing objects with:\n *\n *  - `to`: to address\n *  - `data`: call data\n *\n * @param {string} actions\n * @returns {Array<Object>}\n */\nexport function decodeCallScript (script) {\n  if (!isCallScript(script)) {\n    throw new Error(`Not a call script: ${script}`)\n  }\n\n  let scriptData = script.substring(10)\n  const segments = []\n\n  while (scriptData.length > 0) {\n    const { segment, scriptLeft } = decodeSegment(scriptData)\n    segments.push(segment)\n    scriptData = scriptLeft\n  }\n  return segments\n}\n\n/**\n * Encode a call script\n *\n * ```\n * CallScriptAction {\n *   to: string;\n *   data: string;\n * }\n * ```\n *\n * Example:\n *\n * input:\n * [\n *  { to: 0xaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa, data: 0x11111111 },\n *  { to: 0xbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb, data: 0x2222222222 }\n * ]\n *\n * output:\n * 0x00000001\n *   aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0000000411111111\n *   bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000052222222222\n *\n *\n * @param {Array<CallScriptAction>} actions\n * @returns {string}\n */\nexport function encodeCallScript (actions) {\n  return actions.reduce((script, { to, data }) => {\n    const address = abi.encodeParameter('address', to)\n    const dataLength = abi.encodeParameter('uint256', (data.length - 2) / 2).toString('hex')\n\n    return script + address.slice(26) + dataLength.slice(58) + data.slice(2)\n  }, CALLSCRIPT_ID)\n}\n\n/**\n * Checks whether a EVMScript bytes string is a call script.\n *\n * @param {string} actions\n * @returns {bool}\n */\nexport function isCallScript (script) {\n  // Get script identifier (0x prefix + bytes4)\n  const scriptId = script.substring(0, 10)\n  return scriptId === CALLSCRIPT_ID\n}\n"],"mappings":"gGAAA,gE,oDAqeuB;sJAnehB,KAAMA,cAAa,CAAG,YAAtB,C,mCAEP,QAASC,cAAT,CAAwBC,MAAxB,CAAgC,CAC9B;AACA,KAAMC,GAAE,CAAI,KAAID,MAAM,CAACE,SAAP,CAAiB,CAAjB,CAAoB,EAApB,CAAwB,EAAxC,CACAF,MAAM,CAAGA,MAAM,CAACE,SAAP,CAAiB,EAAjB,CAHqB,CAK9B;AACA,KAAMC,WAAU,CAAiD,CAA9C,CAAAC,QAAQ,CAAE,KAAIJ,MAAM,CAACE,SAAP,CAAiB,CAAjB,CAAoB,CAApB,CAAuB,EAA7B,CAAgC,EAAhC,CAA3B,CACAF,MAAM,CAAGA,MAAM,CAACE,SAAP,CAAiB,CAAjB,CAPqB,CAQ9B,KAAMG,KAAI,CAAI,KAAIL,MAAM,CAACE,SAAP,CAAiB,CAAjB,CAAoBC,UAApB,CAAgC,EAAlD,CAEA;AAGA,MAFAH,OAAM,CAAGA,MAAM,CAACE,SAAP,CAAiBC,UAAjB,CAET,CAAO,CACLG,OAAO,CAAE,CACPL,EADO,CAEPI,IAFO,CADJ,CAKLE,UAAU,CAAEP,MALP,CAOR,CAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GACO,QAASQ,iBAAT,CAA2BR,MAA3B,CAAmC,CACxC,GAAI,CAACS,YAAY,CAACT,MAAD,CAAjB,CACE,KAAM,IAAIU,MAAJ,CAAW,sBAAqBV,MAAO,EAAvC,CAAN,CAGF,GAAIW,WAAU,CAAGX,MAAM,CAACE,SAAP,CAAiB,EAAjB,CAAjB,CACA,KAAMU,SAAQ,CAAG,EAAjB,CANwC,KAQb,CAApB,CAAAD,UAAU,CAACE,MARsB,EAQV,CAC5B,KAAM,CAAEP,OAAF,CAAWC,UAAX,EAA0BR,aAAa,CAACY,UAAD,CAA7C,CACAC,QAAQ,CAACE,IAAT,CAAcR,OAAd,CAF4B,CAG5BK,UAAU,CAAGJ,UACd,CACD,MAAOK,SACR,CAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GACO,QAASG,iBAAT,CAA2BC,OAA3B,CAAoC,CACzC,MAAOA,QAAO,CAACC,MAAR,CAAe,CAACjB,MAAD,QAA0B,IAAjB,CAAEC,EAAF,CAAMI,IAAN,CAAiB,WACxCa,QAAO,CAAGC,mBAAA,CAAIC,eAAJ,CAAoB,SAApB,CAA+BnB,EAA/B,CAD8B,CAExCE,UAAU,CAAGgB,mBAAA,CAAIC,eAAJ,CAAoB,SAApB,CAA+B,CAACf,IAAI,CAACQ,MAAL,CAAc,CAAf,EAAoB,CAAnD,EAAsDQ,QAAtD,CAA+D,KAA/D,CAF2B,CAI9C,MAAOrB,OAAM,CAAGkB,OAAO,CAACI,KAAR,CAAc,EAAd,CAAT,CAA6BnB,UAAU,CAACmB,KAAX,CAAiB,EAAjB,CAA7B,CAAoDjB,IAAI,CAACiB,KAAL,CAAW,CAAX,CAC5D,CALM,CAKJxB,aALI,CAMR,CAED;AACA;AACA;AACA;AACA;AACA,GACO,QAASW,aAAT,CAAuBT,MAAvB,CAA+B,CACpC;AACA,KAAMuB,SAAQ,CAAGvB,MAAM,CAACE,SAAP,CAAiB,CAAjB,CAAoB,EAApB,CAAjB,CACA,MAAOqB,SAAQ,GAAKzB,aACrB"}