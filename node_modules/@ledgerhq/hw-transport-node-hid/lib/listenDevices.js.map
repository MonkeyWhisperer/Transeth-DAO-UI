{"version":3,"sources":["../src/listenDevices.js"],"names":["delay","listenDevicesPollingSkip","events","setMaxListeners","listDevices","flatDevice","d","path","getFlatDevices","Set","map","getDeviceByPaths","find","paths","includes","lastDevices","poll","changeFound","currentDevices","newDevices","filter","length","emit","removeDevices","debouncedPoll","attachDetected","device","on","detachDetected","stop","cancel","removeListener"],"mappings":"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","file":"listenDevices.js","sourcesContent":["// @flow\n\nimport EventEmitter from \"events\";\nimport { getDevices } from \"@ledgerhq/hw-transport-node-hid-noevents\";\nimport { log } from \"@ledgerhq/logs\";\nimport usb from \"usb\";\nimport debounce from \"lodash/debounce\";\n\nexport default (\n  delay: number,\n  listenDevicesPollingSkip: () => boolean\n): ({\n  events: EventEmitter,\n  stop: () => void\n}) => {\n  const events = new EventEmitter();\n  events.setMaxListeners(0);\n\n  let listDevices = getDevices();\n\n  const flatDevice = d => d.path;\n\n  const getFlatDevices = () => [\n    ...new Set(getDevices().map(d => flatDevice(d)))\n  ];\n\n  const getDeviceByPaths = paths =>\n    listDevices.find(d => paths.includes(flatDevice(d)));\n\n  let lastDevices = getFlatDevices();\n\n  const poll = () => {\n    if (!listenDevicesPollingSkip()) {\n      log(\"hid-listen\", \"Polling for added or removed devices\");\n\n      let changeFound = false;\n      const currentDevices = getFlatDevices();\n      const newDevices = currentDevices.filter(d => !lastDevices.includes(d));\n\n      if (newDevices.length > 0) {\n        log(\"hid-listen\", \"New device found:\", newDevices);\n\n        listDevices = getDevices();\n        events.emit(\"add\", getDeviceByPaths(newDevices));\n\n        changeFound = true;\n      } else {\n        log(\"hid-listen\", \"No new device found\");\n      }\n\n      const removeDevices = lastDevices.filter(\n        d => !currentDevices.includes(d)\n      );\n\n      if (removeDevices.length > 0) {\n        log(\"hid-listen\", \"Removed device found:\", removeDevices);\n\n        events.emit(\"remove\", getDeviceByPaths(removeDevices));\n        listDevices = listDevices.filter(\n          d => !removeDevices.includes(flatDevice(d))\n        );\n\n        changeFound = true;\n      } else {\n        log(\"hid-listen\", \"No removed device found\");\n      }\n\n      if (changeFound) {\n        lastDevices = currentDevices;\n      }\n    } else {\n      log(\"hid-listen\", \"Polling skipped, re-debouncing\");\n      debouncedPoll();\n    }\n  };\n\n  const debouncedPoll = debounce(poll, delay);\n\n  const attachDetected = device => {\n    log(\"hid-listen\", \"Device add detected:\", device);\n\n    debouncedPoll();\n  };\n  usb.on(\"attach\", attachDetected);\n  log(\"hid-listen\", \"attach listener added\");\n\n  const detachDetected = device => {\n    log(\"hid-listen\", \"Device removal detected:\", device);\n\n    debouncedPoll();\n  };\n  usb.on(\"detach\", detachDetected);\n  log(\"hid-listen\", \"detach listener added\");\n\n  return {\n    stop: () => {\n      log(\n        \"hid-listen\",\n        \"Stop received, removing listeners and cancelling pending debounced polls\"\n      );\n      debouncedPoll.cancel();\n      usb.removeListener(\"attach\", attachDetected);\n      usb.removeListener(\"detach\", detachDetected);\n    },\n    events\n  };\n};\n"]}